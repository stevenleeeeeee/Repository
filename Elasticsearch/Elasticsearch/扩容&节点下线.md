```bash
# 扩容设计 Docs : https://www.elastic.co/guide/cn/elasticsearch/guide/current/scale.html

# 1 先部署master节点（不启动）
.........

# 2 关闭集群分片负载
# es支持手动迁移索引分片（index shards），需提前关闭自动的shard allocation（防止手动shard迁移和自动shard迁移相扰）
PUT /_cluster/settings
{
    "transient": {
        "cluster.routing.allocation.enable": "none"
        # "cluster.routing.allocation.disable_allocation": true
    }
}

# 3 旧master节点下线转为data节点后启动    # 重复执行，部署新master节点+改造旧master节点
# 4 新master节点加入集群                 #   ? 不确定变更master为data节点后对集群和logstash有没有影响
# 5 开启集群分片负载                     #   ? Master下线时有脑裂的可能
PUT /_cluster/settings
{
    "transient": {
        "cluster.routing.allocation.enable": "all"
        # "cluster.routing.allocation.disable_allocation": false
    }
}

# 6 查看集群状态是否正常  
  PUT /_cluster/health             
```
#### 节点下线
```bash
# 集群中个别节点出现故障预警等情况，需要下线，也是 Elasticsearch 运维工作中常见的情况。
# 如果已经稳定运行过一段时间的集群，每个节点上都会保存有数量不少的分片, 这时通过 reroute 手动转移就显得太过麻烦了。这里还有另一种方式：
curl -XPUT 127.0.0.1:9200/_cluster/settings -d '{
  "transient" :{
      "cluster.routing.allocation.exclude._ip" : "10.0.0.1"
   }
}'
# Elasticsearch 集群就自动把这个 IP 上的所有分片，都自动转移到其他节点上。
# 等到转移完成，这个空节点就可以毫无影响的下线了。
# 和 _ip 类似的参数还有 _host, _name 等。
# 此外，这类参数不单是 cluster 级别，也可以是 index 级别

# 使用 shutdown api 停止一个节点:  POST /_cluster/nodes/_local/_shutdown
```
#### 安全的关闭集群
```bash
# 1.禁止分片自动分布
PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": "none"
  }
}

# 2.执行同步刷新
POST _flush/synced

# 启动后查看状态：
GET _cat/health
GET _cat/recovery
```