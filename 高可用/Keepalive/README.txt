NAT模式：
 将C端来的数据的目的IP换为其中一台RS的IP并发至此RS处理,RS处理后把数据交给LVS后LVS再把源IP改为自己IP并将目的IP改为C端IP
 不论进出流量都必须经过负载均衡，"性能不是很好"
 特点：
 集群中的服务器可使用任何支持TCP/IP的系统而LVS仅需有1个合法IP即可
 但当服务器节点过多时大量数据交汇在LVS导致速度变慢成为性能瓶颈

IP隧道：	
 将C端来的数据"封装"增加新的目的IP发往RS，RS把数据的头解开并还原数据包，处理后直接返回C端（不再经LVS）
 因RS需对LVS发来的包还原所以必须支持IPTUNNEL协议，所以RS的内核必须编译支持IPTUNNEL
 特点：
 LVS仅负责将请求包分发给后端节点从而减少LVS的大量数据交互，这种方式在公网即可进行不同地域分发..
 但各后端节点需合法IP并且需要所有节点支持"IP Tunneling"协议

DR模式：
 LVS和RS都使用相同IP对外服务但仅DR对ARP请求响应，所有RS对此IP的ARP请求静默，也就是说网关把对此IP的请求全部定向给DR
 当DR收到后根据调度算法找出对应RS把目的MAC改为RS的MAC（因IP一致）并将请求分发给这台RS
 RS处理后由于IP一致因此可直接将数据返回C端，"等于直接从客户端收到这个数据包无异"
 因LVS(DR)要对二层包头改换所以LVS和RS间必须在一个广播域（可简单理解为在同一台交换机中）
 特点：
 与TUN相比这种实现不需隧道结构因此可使用大多数操作系统做为后端节点，但其要求负载均衡器的网卡必须与物理网卡在一个物理段

后端调度算法：
 rr：	   纯轮询方式
 wrr：	带权重轮询
 lc：		最小连接数
 wlc：	带权重的，性能高的权重高
 lblc：  缓存服务器集群。基于本地的最小连接。把请求传递到负载小的服务器上
 dh：		realserver中绑定两个ip。ld判断来者的ISP商，将其转到相应的IP
 sh：		源地址散列。基于client地址的来源区分
 sed：	最短的期望的延迟（较复杂）
 nq：    无需队列。若有台realserver的连接数＝0就直接分配过去

---------------------------------------------------------------------- vrrp

是实现路由器高可用的协议，将N台提供相同功能的路由器组成一个路由器组，组里有一个master和多个backup
需配置每个设备的虚拟路由器ID（VRID）和优先值，用VRID将设备分组（有相同VRID的设备为同组，VRID：0~255）
同组的设备使用优先值选举MASTER（大者为MASTER，优先值：0~255）
当内部主机通过ARP查询虚拟IP对应的MAC时MASTER回复的MAC为虚拟的VRRP的MAC而非实际网卡MAC，这样在路由器切换时内网机器觉察不到；
VRRP报文的源地址是本机IP，目的IP为224.0.0.18；IP协议号112；IP包的TTL：255
vrrp用多播传输VRRP报文并使用特殊的虚拟源MAC发送而非自身网卡MAC
运行时仅MASTER定时发送VRRP通告表示其正常（BACKUP仅接收）若指定时间没收到：各BACKUP宣告自己成为MASTER并选举
	1.MASTER实现对虚拟设备的IP的各种网络功能如ARP请求，ICMP，及数据转发；
	2.其他设备不拥有该IP且状态是BACKUP：除接收MASTER的VRRP状态通告外不对外服务
	3.当MASTER失效时BACKUP接管

keepalived仅一个配置文件keepalived.conf，其主要有几个配置区域：
	global_defs、static_ipaddress、static_routes、vrrp_script、vrrp_instance、virtual_server

keepalived三个模块：
	1.core：	为其核心，负责主进程的启动、维护及全局配置文件的加载/解析
	2.check：	负责健康检查，包括各种检查方式
	3.vrrp：	实现VRRP协议


SELECT：
	若对外的VIP就是本身配置的IP，该路由器始终都是MASTER（此时优先值为255）
	若不具备VIP将进行选举，各路由器都发送VRRP通告来宣告自己是MASTER
	若收到其他设备发来通告的优先级比自己高则转回BACKUP，若优先	级相等则比较路由器实际IP（大的优先）

MASTER：
	定时通告、用VRRP虚拟MAC响应路由器IP的ARP请求并转发目的MAC是VRRP虚拟MAC的数据；否则丢弃
	收到shutdown事件时删除定时通告，发送优先权级为0的通告并转初始化状态；若定时通告定时器超时则发送VRRP通告信息；
	收到VRRP通告信息时若优先权为0则发送VRRP通告；否则判断数据的优先级是否高于本机或相等而且实际IP地址大于本地实际IP
	设置定时通告定	时器，复位主机超时定时器，转BACKUP状态；否则丢弃该通告；

BACKUP：
	主机超时定时器、不响应针对虚拟IP的ARP请求信息并丢弃所有目的MAC是虚拟MAC的数据；
	收到shutdown事件时删除主机超时定时器，转初始化状态；
	主机超时定时器超时则发送VRRP通告，广播ARP地址并转MASTER状态；
	收到VRRP通告时若优先权为0，表示进入MASTER选举；否则判断数据的优先级

-----------------------------------------------------------------------------------------------------------

1. 前言

VRRP(Virtual Router Redundancy Protocol)
是用于实现路由器冗余的协议，最新协议在RFC3768中定义，原来的定义RFC2338被废除，新协议相对还简化了一些功能。

2. 协议说明

2.1 协议

VRRP协议是为消除在静态缺省路由环境下的缺省路由器单点故障引起的网络失效而设计的主备模式的协议
使得在发生故障而进行设备功能切换时可不影响内外数据通信，不需要再修改内部网络的网络参数。
VRRP协议需要具有IP地址备份，优先路由选择，减少不必要的路由器间通信等功能。

VRRP协议将两台或多台路由器设备虚拟成一个设备，对外提供虚拟路由器IP(一或多个)
在路由器组内部，如果实际拥有这个对外IP的路由器如果工作正常的话就是MASTER，或者是通过算法选举产生
MASTER实现针对虚拟路由器IP的各种网络功能，如ARP请求，ICMP，以及数据的转发等
其他设备不拥有该IP，状态是BACKUP，除了接收MASTER的VRRP状态通告信息外，不执行对外的网络功能
当MASTER失效时，BACKUP将接管原先MASTER的网络功能。

配置VRRP协议时需要配置每个路由器的虚拟路由器ID(VRID)和优先权值，使用VRID将路由器分组，具有相同VRID值的路由器为同一个组
VRID是一个0～255的正整数；同一组中的路由器通过使用优先值来选举MASTER，优先权大者为MASTER，优先权也是一个0～255的正整数

VRRP协议使用多播数据来传输VRRP数据，VRRP数据使用特殊的虚拟源MAC地址发送数据而不是自身网卡的MAC地址
VRRP运行时只有MASTER路由器定时发送VRRP通告，表示MASTER工作正常以及虚拟路由器IP(组)，BACKUP只接收VRRP数据，不发送数据
如果一定时间内没有接收到MASTER的通告信息，各BACKUP将宣告自己成为MASTER，发送通告信息，重新进行MASTER选举状态

2.2 MASTER选举
如果对外的虚拟路由器IP就是路由器本身配置的IP地址的话，该路由器始终都是MASTER；
否则如果不具备虚拟IP的话，将进行MASTER选举，各路由器都宣告自己是MASTER，发送VRRP通告信息；
如果收到其他机器的发来的通告信息的优先级比自己高，将转回BACKUP状态；
如果优先级相等的话，将比较路由器的实际IP，IP值较大的优先权高；
不过如果对外的虚拟路由器IP就是路由器本身的IP的话，该路由器始终将是MASTER，这时的优先级值为255。

2.3 协议状态机

VRRP协议状态比较简单，就三种状态，初始化，主机，备份机。
                      +---------------+
           +--------->|               |<-------------+
           |          |  Initialize   |              |
           |   +------|               |----------+   |
           |   |      +---------------+          |   |
           |   |                                 |   |
           |   V                                 V   |
   +---------------+                       +---------------+
   |               |---------------------->|               |
   |    Master     |                       |    Backup     |
   |               |<----------------------|               |
   +---------------+                       +---------------+


初始化：
路由器启动时如果路由器的优先级是255(最高优先级)要发送VRRP通告信息，并发送广播ARP通告路由器IP对应的MAC地址为路由虚拟MAC
设置通告信息定时器准备定时发送VRRP通告，转为MASTER状态；否则进入BACKUP状态，设置定时器检查定时检查是否收到MASTER通告

主机：
主机状态下的路由器要完成如下功能：
设置定时通告定时器；
用VRRP虚拟MAC响应路由器IP地址的ARP请求；
转发目的MAC是VRRP虚拟MAC的数据包；
如果是虚拟路由器IP的拥有者，将接受目的地址是虚拟路由器IP的数据包，否则丢弃；
当收到shutdown的事件时删除定时通告定时器，发送优先权级为0的通告包，转初始化状态；
如果定时通告定时器超时时，发送VRRP通告信息；
收到VRRP通告信息时，如果优先权为0，发送VRRP通告信息；否则判断数据的优先级是否高于本机或相等且实际IP地址大于本地实际IP
设置定时通告定时器，复位主机超时定时器，转BACKUP状态；否则的话，丢弃该通告包；

备机：
备机状态下的路由器要实现以下功能：
设置主机超时定时器；
不能响应针对虚拟路由器IP的ARP请求信息；
丢弃所有目的MAC地址是虚拟路由器MAC地址的数据包；
不接受目的是虚拟路由器IP的所有数据包；
当收到shutdown的事件时删除主机超时定时器，转初始化状态；
主机超时定时器超时的时候，发送VRRP通告信息，广播ARP地址信息，转MASTER状态；
收到VRRP通告信息时，如果优先权为0，表示进入MASTER选举；否则判断数据的优先级是否高于本机
如果高的话承认MASTER有效，复位主机超时定时器；否则丢弃该通告包；

2.4 ARP查询处理

当内部主机通过ARP查询VIP地址对应的MAC时，MASTER回复的MAC为虚拟的VRRP的MAC地址，而不是实际网卡的MAC地址
这样在路由器切换时让内网机器觉察不到；而在路由器重新启动时，不能主动发送本机网卡的实际MAC地址。
如果虚拟路由器开启的ARP代理(proxy_arp)功能，代理的ARP回应也回应VRRP虚拟MAC地址

2.5 VRRP应用举例

            +-----------+      +-----------+
            |   Rtr1    |      |   Rtr2    |
            |(MR VRID=1)|      |(BR VRID=1)|
            |(BR VRID=2)|      |(MR VRID=2)|
    VRID=1  +-----------+      +-----------+  VRID=2
    IP A ---------->*            *<---------- IP B
                    |            |
                    |            |
  ------------------+------------+-----+--------+--------+--------+--
                                       ^        ^        ^        ^
                                       |        |        |        |
                                     (IP A)   (IP A)   (IP B)   (IP B)
                                       |        |        |        |
                                    +--+--+  +--+--+  +--+--+  +--+--+
                                    |  H1 |  |  H2 |  |  H3 |  |  H4 |
                                    +-----+  +-----+  +--+--+  +--+--+
     Legend:
              ---+---+---+--  =  Ethernet, Token Ring, or FDDI
                           H  =  Host computer
                          MR  =  Master Router
                          BR  =  Backup Router
                           *  =  IP Address
                        (IP)  =  default router for hosts


这是通常VRRP使用拓扑，两台路由器运行VRRP互为备份
路由器1作为VRID组1的MASTER，IP地址A，VRID组2的BACKUP
路由器2作为VRID组2的MASTER，IP地址B，VRID组1的BACKUP
内部网络中一部分机器的缺省网关地址是IP地址A，一部分是IP地址B
正常情况下以A为网关的数据将走路由器1，以B为网关的数据将走路由器2，如果一台路由器发生故障，所有数据将走另一台路由器。

3. 协议定义

3.1 以太头

源MAC地址必须为虚拟MAC地址：00-00-5E-00-01-{VRID}
VRID为虚拟路由器ID值
16进制格式
所以同一网段中最多有255个VRRP路由器
目的MAC为多播类型的MAC。


3.2 IP头参数

VRRP包的源地址是本机地址，目的地址必须为224.0.0.18，为一多播地址；IP协议号为112；IP包的TTL值必须为255。

3.3 VRRP协议数据格式
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version| Type  | Virtual Rtr ID|   Priority    | Count IP Addrs|
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |   Auth Type   |   Adver Int   |          Checksum             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                         IP Address (1)                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                            .                                  |
   |                            .                                  |
   |                            .                                  |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                         IP Address (n)                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     Authentication Data (1)                   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     Authentication Data (2)                   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


其中：
version：版本，4位，在RFC3768中定义为2；
Type：类型，4位，目前只定义一种类类型：通告数据，取值为1；
Virtual Rtr ID：虚拟路由器ID，8位
Priority：优先级，8位，具备冗余IP地址的设备的优先级为255；
Count IP Addrs：VRRP包中的IP地址数量，8位；
Auth Type：认证类型，8位，RFC3768中认证功能已经取消，此字段值定义0(不认证)，为1，2只作为对老版本的兼容；
Adver Int：通告包的发送间隔时间，8位，单位是秒，缺省是1秒；
Checksum：校验和，16位，校验数据范围只是VRRP数据，即从VRRP的版本字段开始的数据，不包括IP头；
IP Address(es)：和虚拟路由器相关的IP地址，数量由Count IP Addrs决定
Authentication Data：RFC3768中定义该字段只是为了和老版本兼容，必须置0。

3.4 接收数据时的必须检查

收到VRRP数据包时要进行以下验证，不满足的数据包将被丢弃：
   -  TTL必须为255；
   -  VRRP版本号必须为2；
   -  一个包中数据字段必须完整；
   -  校验和必须正确；
   -  必须验证在接收的网卡上配置了VRID值，而且本地路由器不是路由IP地址的拥有者
   -  必须验证VVRP认证类型和配置的一致；


4. 结论

VRRP实现了对路由器IP地址的冗余功能，防止了单点故障造成的网络失效
VRRP本身是热备形式的，但可以通过互相热备实现路由器的均衡处理
新版VRRP较老版简化了认证处理，实际不再进行数据的认证，这是因为在实际应用中经常出现认证成为造成多个MASTER同时使用的异常
